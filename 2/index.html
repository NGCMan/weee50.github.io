<!---
This file originates from http://heptaveegesimal.com
You may reupload this file in any noncommercial way as long as this reference and the link on the page is kept and you do not weaken these conditions for anyone downloading the version you have modified.

Chain of edits (You may add yourself below, but not remove anyone above):
> Original File : http://heptaveegesimal.com
> First Editor  : weee50
> Second Editor : ...
> ...
--->
<!--- Php Test
<?php
$mobile = false;
if($_GET['mobile'] == "1") $mobile = true;
?>
--->
<html>
<head>
  <title>Heptaveegesimal</title>
  <link href="style_5.css" rel="stylesheet" type="text/css" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="utf-8">
</head>
<body>
  <!--- Head Of Page --->
  <center>
    <p class="top"><font size="6"><em>Heptaveegesimal</em></font><br>
      <font size="4" id="ins_1"> Custom Minesveeper | <a href="http://heptaveegesimal.com/2018/advent-calendar/">Reupload of this version</a> </font>
    </p>
  </center>
  <!--- Actual Page Content --->
  <div class="normalText">
    <center>
        <h1>Week 2 - Cursor</h1>
        <table>
          <tr>
          <td>
            <table class="invis">
            <tr class="invis">
              <td class="invis"><!-- Top Left -->
              <td class="invis">
                <table class="invis" id="Top-Numbers">
                  <tr class="invis">
                </table>
              <td class="invis"><!-- Top Right -->
            <tr class="invis">
              <td class="invis">
                <table class="invis" id="Left-Numbers">
                </table>
              <td class="invis">
                <canvas id="canvas_1" width="0" height="0" style="border:1px solid #000000;" oncontextmenu="return false">
              <td class="invis">
                <table class="invis" id="Right-Numbers">
                </table>
            <tr class="invis">
              <td class="invis"><!-- Bottom Left -->
              <td class="invis">
              <table class="invis" id="Bottom-Numbers">
                  <tr class="invis">
                </table>
              <td class="invis"><!-- Bottom Right -->
          </table>
          </canvas>
          <td width="200" valign="top" style="position:relative">
            <div style="margin:7px">
              <!--- Top Display --->
              <div style="width:172px;"><center><button type="button" class="greenbutton" id="mobileLR">Left Click</button></center></div>
              <div id="count_sec_open">
                <img src="Flag_0.png"></img><div id="count_tex_open" style="display:inline; margin-left:7px">Hallo</div>
                <br>
              </div>
              <div id="count_sec_1flag">
                <img src="Flag_1.png"></img><div id="count_tex_1flag" style="display:inline; margin-left:7px"">Hallo</div>
                <br>
              </div>
              <div id="count_sec_2flag">
                <img src="Flag_2.png"></img><div id="count_tex_2flag" style="display:inline; margin-left:7px"">Hallo</div>
                <br>
              </div>
              <div id="count_sec_3flag">
                <img src="Flag_3.png"></img><div id="count_tex_3flag" style="display:inline; margin-left:7px">Hallo</div>
              </div>
              <div id="count_sec_-1flag">
                <img src="Flag_-1.png"></img><div id="count_tex_-1flag" style="display:inline; margin-left:7px"">Hallo</div>
                <br>
              </div>
              <div id="TorusNavigator">
                <br>
                <table class="invis">
                  <tr class="invis">
                    <td class="invis">
                    <td class="invis"><button type="button" class="greenbutton" id="tn_u"><img src="Arrow_Up.png"></button>
                    <td class="invis">
                  <tr class="invis">
                    <td class="invis"><button type="button" class="greenbutton" id="tn_l"><img src="Arrow_Left.png"></button>
                    <td class="invis">
                    <td class="invis"><button type="button" class="greenbutton" id="tn_r"><img src="Arrow_Right.png"></button>
                  <tr class="invis">
                    <td class="invis">
                    <td class="invis"><button type="button" class="greenbutton" id="tn_d"><img src="Arrow_Down.png"></button>
                    <td class="invis">
                </table>
              </div>
            </div>
            <div style="position:absolute; bottom:0px; left:0px"><div style="margin:7px">
              <!--- Bottom Text --->
              <div id="deathTimerSec" class="hide">
                <b>Death in:<font id="deathTimerCol" color="#00ff00"><div id="deathTimer" style="font-family:'Courier New'; font-size:20px; margin-left:16px">0:05.000</div></font></b>
              </div>
              <br>
              <b>Time:<div id="regularTimer" style="font-family:'Courier New'; font-size:20px; margin-left:16px">0:00.000</div></b>
              <!-- <? if(!$mobile) echo $htmlClose."<br>".$htmlOpen; ?> -->
              <div style="width:172px;"><center><button type="button" class="redbutton" id="restartButton">Restart</button></center></div>
            </div></div>
        </table>
      <div id="Description" class="out_blue"><p align="left">
        First of all, I need to have the link to the original <a href="http://heptaveegesimal.com/2018/advent-calendar/">advent calendar</a>.<br>
        <br>
        So, today's mechanic will be a new entity: the Cursor.<br>
        Today, you will not be able to open or flag tiles normally (besides the first click).<br>
        Instead, you will need to use the Cursor to accomplish this. The Cursor has the same movement mechanics as the sheep, moving one tile in the direction where you clicked (including diagonals) and opening any tile it touches.<br>
        <br>
        If you right-click anywhere, the Cursor will turn red. The red Cursor will instead flag every tile that it touches. If a tile is already flagged, it will instead unflag it.<br>
        Right click again to change the Cursor's color back to white.<br>
        <br>
        These features mean the game still has all of its usual controls, it's just a different way to use them similar to day 14 of the real advent calendar.<br>
        <br>
        Thanks to Joshua (the creator of the original advent calendar) for providing a fix for the invisible cursor bug.<br>
      </div>
    </center>
  <!--- Scripts --->
  <!--- Global Variables --->
  <script>
    var Shape_Normal = [[-1,-1],[0,-1],[1,-1],[-1,0],[1,0],[-1,1],[0,1],[1,1]];
    var Shape_Normal_WAXD = [[-1,-1],[0,-1],[1,-1],[-1,0],[1,0],[-1,1],[0,1],[1,1],[0,-1],[0,1],[-1,0],[1,0]];
    var Shape_Knight = [[-2,-1],[-2,1],[2,-1],[2,1],[-1,-2],[1,-2],[-1,2],[1,2]];
    var Shape_Hammer = [[-1,-1],[0,-1],[1,-1],[-1,-2],[0,-2],[1,-2]];
    //var Shape_SandGlass = [[0,1],[-1,2],[0,2],[1,2],[0,-1],[-1,-2],[0,-2],[1,-2]];
    //var Shape_Plus = [[-2,0],[-1,0],[1,0],[2,0],[0,-2],[0,-1],[0,1],[0,2]];
    var Shape_Far = [[-1,-2],[0,-2],[1,-2],[-1,0],[1,0],[-1,2],[0,2],[1,2]];
    var Cursor = {img:null, src:"Cursor.png", x:0, y:0, ai:{dig:null, flag:null, voidClickL:null, voidClickR:null, init:null}};
    var isMobile = false;
    /* <? if($mobile) echo "*"."/ isMobile = true; /*" ?> */
    var mobileLeftclick = true;
    // *************************************************************************************** //
    
    var Generator = {sx: 20, sy: 20, mineMax: 1, amount:[60], shape:Shape_Normal, wrap:[0,0], entities:[Cursor]};
    
    // *************************************************************************************** //
    var flagmode = false;
    var Shape;
    var hasBeenGenerated;
    var GameState;
    var XWrap;
    var YWrap;
    var screenscale = 16;
    var Textures;
    var sizeX;
    var sizeY;
    var maxFlags;
    var field;
    var confused;
    var timeOffset = 0;
    var lastCounterTime = 0;
    var startingTime;
    var canvas = document.getElementById("canvas_1");
    var cont = canvas.getContext("2d");
    var timer = document.getElementById("regularTimer");
    var lastDigTime;
    var death_timer = document.getElementById("deathTimer");
    var death_timer_sec = document.getElementById("deathTimerSec");
    var death_timer_col = document.getElementById("deathTimerCol");
    var mobileButton = document.getElementById("mobileLR");
    var chord = {time:0, x:0, y:0, lock:false};
    var sideNumbers = {
      left  : document.getElementById("Left-Numbers"),
      right : document.getElementById("Right-Numbers"),
      top   : document.getElementById("Top-Numbers"),
      bottom: document.getElementById("Bottom-Numbers"),
    };
    var counterDisplay = {
      Floor:{
        c:0,
        t:0,
        div_sec:document.getElementById('count_sec_open'),
        div_tex:document.getElementById('count_tex_open')
      },
      Mines:[{
        c:0,
        t:0,
        div_sec:document.getElementById('count_sec_1flag'),
        div_tex:document.getElementById('count_tex_1flag')
      },{
        c:0,
        t:0,
        div_sec:document.getElementById('count_sec_2flag'),
        div_tex:document.getElementById('count_tex_2flag')
      },{
        c:0,
        t:0,
        div_sec:document.getElementById('count_sec_3flag'),
        div_tex:document.getElementById('count_tex_3flag')
      }],
      AntiMines:{
        c:0,
        t:0,
        div_sec:document.getElementById('count_sec_-1flag'),
        div_tex:document.getElementById('count_tex_-1flag')
      }
};
  </script>
  <!--- Important Scripts --->  
  <script language="javascript" type="text/javascript" src="LoadImages.js"></script>
  <script language="javascript" type="text/javascript" src="RunTimeFunctions.js"></script>
  <script language="javascript" type="text/javascript" src="Zen.js"></script>
  <!--- Assign on click function to canvas --->
  <script>
    //Entity AI
    function toTarget(E, x, y){
      if(E.x < x) E.x++;
      if(E.x > x) E.x--;
      if(E.y < y) E.y++;
      if(E.y > y) E.y--;
    }
    function setPos(E, x, y){
      E.x = x;
      E.y = y;
    }
    function initChordLock(E, x, y){
      setPos(E, x, y);
      chord.lock = true;
      Cursor.img.src = "Cursor.png"
    }
    //Cursor
    Cursor.ai.init = initChordLock;
    Cursor.ai.dig = function(E, x, y){
      if (!flagmode) {
        toTarget(E, x, y);
        if (field[E.x][E.y].flags == 0) {
          field[E.x][E.y].open = true;
          if(field[E.x][E.y].mines != 0){
            GameState = 2;
          }else{
            if(field[E.x][E.y].neighbours == 0){
              digAround(E.x, E.y);
            }
          }
        drawStuff();
        if(counterDisplay.Floor.c == counterDisplay.Floor.t){
          GameState = 3;
        }
        }
      } else {
        toTarget(E, x, y);
        if (!field[E.x][E.y].open) {
          if (field[E.x][E.y].flags == 0) {
            field[E.x][E.y].flags = 1;
          } else {
            field[E.x][E.y].flags = 0;
          }
        }
      }
    };
    // Thanks to Joshua (the creator of the original advent calendar) for providing this fix for the invisible cursor bug
    Cursor.ai.voidClickL = Cursor.ai.dig;
    Cursor.both = [new Image(), new Image()];
    Cursor.both[0].src = "Cursor.png";
    Cursor.both[1].src = "CursorRed.png";
    Cursor.ai.flag = function(E, x, y){
      flagmode = !flagmode;
      if (flagmode) {
        E.img = E.both[1];
      } else {
        E.img = E.both[0];
      }
    drawStuff();
    }
    Cursor.ai.voidClickR = Cursor.ai.flag;
    //Events
    canvas.addEventListener('mouseup', function(event) {
      var i = event.pageX - canvas.getBoundingClientRect().left - 1 - window.pageXOffset;
      var j = event.pageY - canvas.getBoundingClientRect().top - 1 - window.pageYOffset;
      i = Math.floor(i / screenscale);
      j = Math.floor(j / screenscale);
      if((i >= 0)&&(j >= 0)&&(i < sizeX)&&(j < sizeY)){
        if(event.button == 0){
          if(document.selection && document.selection.empty) {
            document.selection.empty();
          } else if(window.getSelection) {
            let sel = window.getSelection();
            sel.removeAllRanges();
          }
        }
        if((isMobile ? (!mobileLeftclick) : (event.button == 2)) ^ confused){
          rightClick(i, j);
        }else{
          leftClick(i, j);
        }
      }
    }, false);
    document.getElementById("restartButton").onclick = function(){
      startNewGame();
    };
    if(isMobile){
      mobileButton.onclick = function(){
        if(mobileLeftclick){
          mobileLeftclick = false;
          mobileButton.innerText = "Right Click";
        }else{
          mobileLeftclick = true;
          mobileButton.innerText = "Left Click";
        }
      };
    } else {
      mobileButton.className = "hide";
    }
    //Torus Navigator
    function moveField(dir, tan, sizeDir, sizeTan){
      let i;
      let j;
      let h;
      let f = function(A, lA, B, lB){
        return intoBounds([A[0] * lA + B[0] * lB, A[1] * lA + B[1] * lB]);
      }
      for(i = 0; i < sizeTan; i++){
        let p1 = f(dir, 0, tan, i);
        let p2 = p1;
        let h = field[p1[0]][p1[1]];
        for(j = 1; j < sizeDir; j++){
          p1 = f(dir, j-1, tan, i);
          p2 = f(dir, j, tan, i);
          field[p1[0]][p1[1]] = field[p2[0]][p2[1]];
        }
        field[p2[0]][p2[1]] = h;
      }
      drawStuff();
    }
    document.getElementById("tn_d").onclick = function(){moveField([0,-1],[1,0],Generator.sy,Generator.sx);};
    document.getElementById("tn_r").onclick = function(){moveField([-1,0],[0,1],Generator.sx,Generator.sy);};
    document.getElementById("tn_l").onclick = function(){moveField([1,0],[0,1],Generator.sx,Generator.sy);};
    document.getElementById("tn_u").onclick = function(){moveField([0,1],[1,0],Generator.sy,Generator.sx);};
    
    //Recolors
    var RecolorMap = [[0, 47, 48, 49, 50],[51, 1, 52, 53, 54],[55, 56, 2, 57, 58],[59, 60, 61, 3, 62],[63, 64, 65, 66, 4]];
    for(let i = 0; i < 20; i++){
      Textures.Ground[47 + i] = new Image();
    }
    Textures.Ground[47].src = "Color_0_to_1.png";
    Textures.Ground[48].src = "Color_0_to_2.png";
    Textures.Ground[49].src = "Color_0_to_3.png";
    Textures.Ground[50].src = "Color_0_to_4.png";
    
    Textures.Ground[51].src = "Color_1_to_0.png";
    Textures.Ground[52].src = "Color_1_to_2.png";
    Textures.Ground[53].src = "Color_1_to_3.png";
    Textures.Ground[54].src = "Color_1_to_4.png";
    
    Textures.Ground[55].src = "Color_2_to_0.png";
    Textures.Ground[56].src = "Color_2_to_1.png";
    Textures.Ground[57].src = "Color_2_to_3.png";
    Textures.Ground[58].src = "Color_2_to_4.png";
    
    Textures.Ground[59].src = "Color_3_to_0.png";
    Textures.Ground[60].src = "Color_3_to_1.png";
    Textures.Ground[61].src = "Color_3_to_2.png";
    Textures.Ground[62].src = "Color_3_to_4.png";
    
    Textures.Ground[63].src = "Color_4_to_0.png";
    Textures.Ground[64].src = "Color_4_to_1.png";
    Textures.Ground[65].src = "Color_4_to_2.png";
    Textures.Ground[66].src = "Color_4_to_3.png";
    
    let hasNoEntities = true;
    if(Array.isArray(Generator.entities)){
      hasNoEntities = (Generator.entities.length == 0);
    }
    if((Generator.wrap[0] == 1) && (Generator.wrap[1] == 1) && hasNoEntities){
      TorusNavigator.className = "";
    }else{
      TorusNavigator.className = "hide";
    }
    startNewGame();
    
    setTimeout(function() {drawStuff();}, 50);
    setTimeout(function() {drawStuff();}, 200);
    setTimeout(function() {drawStuff();}, 500);
    setTimeout(function() {drawStuff();}, 1000);
  </script>
  </body>
</html>
